@page
@model Lost_and_Found.Views.Lost.LostIndexModel

@{
    Layout = null;
}

@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    var userId = HttpContextAccessor.HttpContext?.Session?.GetInt32("UserId");
}

<link href="~/css/Lost.css" rel="stylesheet" />

<div id="customModal" class="custom-modal"
     style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); overflow:auto;">

    <div class="custom-modal-content"
         style="background:linear-gradient(to right,#FCE4EC,#E9F6C9); margin:5% auto; padding:25px 30px; border-radius:15px; width:480px; position:relative; animation:fadeIn 0.3s ease; max-height:90vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.2);">

        <span class="close-btn"
              style="position:absolute; top:15px; right:20px; font-size:25px; cursor:pointer; color:#333;">&times;</span>

        <h2 style="text-align:center; padding-top:25px; margin-top:-27px; margin-bottom:20px;">User Report Item</h2>

        <div class="ReportLostForm"
             style="box-shadow:0 4px 15px rgba(0,0,0,0.2); padding:25px; height:auto; width:100%; margin:auto; border-radius:15px; background:#fff;">

            <input type="hidden" id="OwnerUserId" name="OwnerUserId" />
            <input type="hidden" id="LostItemId" name="LostItemId" />
            <img alt="Owner Image" class="ownerImg" style="display: none;" />


            <!-- Name -->
            <div class="form-group" style="display:flex; align-items:center; margin-bottom:20px;">
                <label for="name" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Name :</label>
                <input type="text" id="name" name="name"
                       value="@HttpContextAccessor.HttpContext?.Session.GetString("UserName")"
                       readonly required
                       style="flex-grow:1; padding:2px 7px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em;">
            </div>

            <!-- Item -->
            <div class="form-group" style="display:flex; align-items:center; margin-bottom:20px;">
                <label for="item" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Item :</label>
                <input type="text" name="item" id="item" style="flex-grow:1; padding:2px 7px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em;" readonly />
            </div>

            <!-- Location -->
            <div class="form-group" style="display:flex; align-items:center; margin-bottom:20px;">
                <label for="location1" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Location :</label>
                <input type="text" id="location1" name="location1" required
                       style="flex-grow:1; padding:2px 7px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em;">
            </div>

            <!-- Date -->
            <div class="form-group" style="display:flex; align-items:center; margin-bottom:20px;">
                <label for="date" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Date :</label>
                <div class="date-input-container" style="flex-grow:1; position:relative;">
                    <input type="date" id="date" name="date" required
                           style="width:100%; padding:5px 35px 5px 10px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em;">
                    <span class="date-icon" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:1.1em; color:#666;">&#128197;</span>
                </div>
            </div>

            <!-- Description -->
            <div class="form-group" style="display:flex; align-items:flex-start; margin-bottom:20px;">
                <label for="description" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Item Description :</label>
                <textarea id="description" name="description" rows="4"
                          style="flex-grow:1; padding:5px 7px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em; resize:vertical;"></textarea>
            </div>

            <!-- Photo Upload -->
            <div class="form-group" style="display:flex; align-items:flex-end; margin-top:30px;">
                <label for="photo" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Upload Photo :</label>
                <div id="photoContainer"
                     style="flex-grow:1; position:relative; padding:5px 10px; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border:1px solid #ccc; border-radius:4px; cursor:pointer; display:flex; align-items:center; min-width:100px;">
                    <input type="file" id="photo" name="photo" accept="image/*" style="display:none;">
                    <span class="upload-text" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#555; font-size:0.9em;">(Upload pic)</span>
                </div>
            </div>

            <!-- Buttons -->
            <div class="button-group" style="display:flex; justify-content:flex-start; gap:15px; margin-top:30px; margin-left:100px;">
                <button type="button" onclick="ReportDataOfUser()"
                        style="padding:3px 20px; background-color:#4a4a4a; color:white; border:none; border-radius:4px; font-size:0.9em; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                    Submit
                </button>
            </div>
        </div>
    </div>
</div>











































<partial name="~/Views/Navbar/NavbarIndex.cshtml" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<div class="Lost" style="height:495px;">
    <h2 style="text-align:center;font-size:35px;margin-top:10px;margin-bottom: -23px;">Lost Items</h2>
    <div class="searchbar" id="searchbar">
        <span class="icon-left"><i class="fa-solid fa-bars"></i></span>
        <input type="text" placeholder="Item Name" name="search" id="search">
        <span class="icon-right"><i class="fa-solid fa-magnifying-glass" onclick="SearchItem()"></i></span>
    </div>

    <div class="RBtn">
        <button onclick="GetLostData()">Get Your Report</button>
        <button onclick=" GetLostDataAll()">Get Other Report</button>
    </div>

    <div class="container">
        
    </div>
</div>
<partial name="~/Views/Footer/FooterIndex.cshtml" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<script>
    $(document).ready(function()
    {
        GetLostDataAll();

        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                let latitude = pos.coords.latitude;
                let longitude = pos.coords.longitude;
                let url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`;

                // try 
                // {
                    let response = await fetch(url);
                    let value = await response.json();
                    $("#location1").val(value.display_name);
                // } catch (err) {
                //     alert("Error retrieving location.");
                // }
            });
        } else {
            alert("Geolocation not supported by your browser.");
        }
    });


    function GetLostDataAll()
    {
        let userId = '@userId';

        if (!userId)
        {
            console.warn("User ID not found in session!");
            return;
        }

        $.ajax({
            url: '/Lost/FetchData',
            type: 'POST',
            data: { userId: userId },
            success: function(response)
            {
                console.log(response);

                let container = $('.container');
                container.empty();

                if (!response || response.length === 0)
                {
                    container.html('<p style="text-align:center;">No items found</p>');
                    return;
                }

                response.forEach(item => {
                    let cardHtml = `
                        <div class="student-card" data-userid="${item.userId}" data-id="${item.id}">
                            <div></div>
                            <div class="card-header">
                                <div class="avatar">${item.name ? item.name.charAt(0) : '?'}</div>
                                <div class="info">
                                    <h3>${item.name}</h3>
                                    <p>${new Date(item.dateLost).toLocaleDateString()}</p>
                                </div>
                            </div>

                            <div class="card-image">
                                <img src="${item.photoPath}" alt="${item.item}" />
                            </div>

                            <div class="card-content">
                                <h4>Item: ${item.item}</h4>
                                <p class="location">Location: ${item.location}</p>
                                <p class="description">Desc: ${item.description}</p>
                                <p class="phone">Phone: ${item.phone}</p>
                            </div>

                            <div class="card-footer">
                                <button class="contact-btn" type="button">Contact</button>
                            </div>
                        </div>
                    `;
                    container.append(cardHtml);
                });
            },
            error: function(xhr, status, error)
            {
                console.error("AJAX Error:", error);
            }
        });
    }

    function GetLostData()
    {
        let userId = '@userId';

        if (!userId)
        {
            console.warn("User ID not found in session!");
            return;
        }

        $.ajax({
            url: '/Lost/FetchData1',
            type: 'POST',
            data: { userId: userId },
            success: function(response)
            {
                console.log(response);

                let container = $('.container');
                container.empty();

                if (!response || response.length === 0)
                {
                    container.html('<p style="text-align:center;">No items found</p>');
                    return;
                }

                response.forEach(item => {
                    let cardHtml = `
                        <div class="student-card">
                            <div class="card-header">
                                <div class="avatar">${item.name ? item.name.charAt(0) : '?'}</div>
                                <div class="info">
                                    <h3>${item.name}</h3>
                                    <p>${new Date(item.dateLost).toLocaleDateString()}</p>
                                </div>
                            </div>

                            <div class="card-image">
                                <img src="${item.photoPath}" alt="${item.item}" />
                            </div>

                            <div class="card-content">
                                <h4>Item: ${item.item}</h4>
                                <p class="location">Location: ${item.location}</p>
                                <p class="description">Desc: ${item.description}</p>
                                <p class="phone">Phone: ${item.phone}</p>
                            </div>

                            <div class="card-footer">
                                <button class="contact-btn" disabled>Contact</button>
                            </div>
                        </div>
                    `;
                    container.append(cardHtml);
                });
            },
            error: function(xhr, status, error)
            {
                console.error("AJAX Error:", error);
            }
        });
    }



    function SearchItem() 
    {
        let item = document.getElementById("search").value; 
        let userId = '@userId';

        if (!userId)
        {
            console.warn("User ID not found in session!");
            return;
        }

        $.ajax({
            url: '/Lost/Search',
            type: 'POST',
            data: { userId: userId , item : item},
            success: function(response)
            {
                console.log(response);

                let container = $('.container');
                container.empty();

                if (!response || response.length === 0)
                {
                    container.html('<p style="text-align:center;">No items found</p>');
                    return;
                }

                response.forEach(item => {
                    let cardHtml = `
                        <div class="student-card">
                            <div class="card-header">
                                <div class="avatar">${item.name ? item.name.charAt(0) : '?'}</div>
                                <div class="info">
                                    <h3>${item.name}</h3>
                                    <p>${new Date(item.dateLost).toLocaleDateString()}</p>
                                </div>
                            </div>

                            <div class="card-image">
                                <img src="${item.photoPath}" alt="${item.item}" />
                            </div>

                            <div class="card-content">
                                <h4>Item: ${item.item}</h4>
                                <p class="location">Location: ${item.location}</p>
                                <p class="description">Desc: ${item.description}</p>
                                <p class="phone">Phone: ${item.phone}</p>
                            </div>

                            <div class="card-footer">
                                <button class="contact-btn" disabled>Contact</button>
                            </div>
                        </div>
                    `;
                    container.append(cardHtml);
                });
            },
            error: function(xhr, status, error)
            {
                console.error("AJAX Error:", error);
            }
        });
    }









    $(document).on('click', '.contact-btn', function () 
    {
        const card = $(this).closest('.student-card');

        const itemName = card.find('h4').text().replace('Item: ', '');
        const ownerUserId = card.data('userid');  
        const lostItemId = card.data('id');    
        const photoPath = card.find('.card-image img').attr('src');
        console.log(photoPath);

        $('#item').val(itemName);
        $('#OwnerUserId').val(ownerUserId);
        $('#LostItemId').val(lostItemId);
        $('.ownerImg').attr('src', photoPath);

        $('#customModal').fadeIn(200);
    });


    $(document).on('click', '.close-btn', function () 
    {
        $('#customModal').fadeOut(200);
    });

    $(window).on('click', function (e) 
    {
        if ($(e.target).is('#customModal')) 
        {
            $('#customModal').fadeOut(200);
        }
    });



    const fileInput = document.getElementById('photo');
    const uploadText = document.querySelector('.upload-text');
    const uploadContainer = document.getElementById('photoContainer');

    uploadContainer.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', () => {
        if (fileInput.files && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            uploadText.textContent = file.name;
        } else {
            uploadText.textContent = "(Upload pic)";
        }
    });


    function ReportDataOfUser() 
    {
        const ReporterId = '@userId';
        const reporterName = document.getElementById("name").value;
        const location = document.getElementById("location1").value;
        const date = document.getElementById("date").value;
        const description = document.getElementById("description").value;
        const ownerUserId = document.getElementById("OwnerUserId").value;
        const lostItemId = document.getElementById("LostItemId").value;
        const photo = document.getElementById("photo").files[0];
        const OwnerImg = document.getElementsByClassName("ownerImg")[0].src;
        console.log(OwnerImg);

        const formData = new FormData();

        formData.append("ReporterId", ReporterId);
        formData.append("ReporterName", reporterName);
        formData.append("Location", location);
        formData.append("Date", date);
        formData.append("Description", description);
        formData.append("OwnerUserId", ownerUserId);
        formData.append("LostItemId", lostItemId);
        formData.append("Photo", photo);
        formData.append("OwnerImg", OwnerImg);


        $.ajax({
            url: '/Lost/ReportUser',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                // alert("✅ Report submitted successfully!");
                $('#customModal').fadeOut(200);
                Swal.fire({
                icon: 'success',
                title: 'Report Submitted!',
                text: 'Your report has been sent successfully to the owner.',
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'OK'
            }).then(() => {
                // optional: reset form or reload page
                document.getElementById("reportForm").reset();
            });
            },
            error: function (xhr, status, error) {
                console.error("❌ Error submitting report:", error);
                Swal.fire({
                icon: 'error',
                title: 'Submission Failed',
                text: 'Something went wrong while submitting the report!',
                confirmButtonColor: '#d33'
            });
                
            }
        });
    }
</script>
