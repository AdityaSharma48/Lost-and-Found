@page
@model Lost_and_Found.Views.ReportFound.ReportFoundIndexModel




@{
    Layout = null;
}

@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    var userId = HttpContextAccessor.HttpContext?.Session?.GetInt32("UserId");
}

<link href="~/css/Lost.css" rel="stylesheet" />




<div id="customModal" class="custom-modal"
     style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); overflow:auto;">

    <div class="custom-modal-content"
         style="background:linear-gradient(to right,#FCE4EC,#E9F6C9); margin:5% auto; padding:25px 30px; border-radius:15px; width:480px; position:relative; animation:fadeIn 0.3s ease; max-height:90vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.2);">

        <span class="close-btn"
              style="position:absolute; top:15px; right:20px; font-size:25px; cursor:pointer; color:#333;">&times;</span>

        <h2 style="text-align:center; padding-top:25px; margin-top:-27px; margin-bottom:20px;">User Report Item</h2>

        <div class="ReportLostForm"
             style="box-shadow:0 4px 15px rgba(0,0,0,0.2); padding:25px; height:auto; width:100%; margin:auto; border-radius:15px; background:#fff;">

            <input type="hidden" id="OwnerUserId" name="OwnerUserId" />
            <input type="hidden" id="LostItemId" name="LostItemId" />

            <!-- Name -->
            <div class="form-group" style="display:flex; align-items:center; margin-bottom:20px;">
                <label for="name" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Name :</label>
                <input type="text" id="name" name="name"
                       value="@HttpContextAccessor.HttpContext?.Session.GetString("UserName")"
                       readonly required
                       style="flex-grow:1; padding:2px 7px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em;">
            </div>

            <!-- Item -->
            <div class="form-group" style="display:flex; align-items:center; margin-bottom:20px;">
                <label for="item" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Item :</label>
                <input type="text" name="item" id="item" style="flex-grow:1; padding:2px 7px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em;" readonly />
            </div>

            <!-- Location -->
            <div class="form-group" style="display:flex; align-items:center; margin-bottom:20px;">
                <label for="location" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Location :</label>
                <input type="text" id="location" name="location" readonly
                       style="flex-grow:1; padding:2px 7px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em;">
            </div>

            <!-- Date -->
            <div class="form-group" style="display:flex; align-items:center; margin-bottom:20px;">
                <label for="date" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Date :</label>
                <div class="date-input-container" style="flex-grow:1; position:relative;">
                    <input type="date" id="date" name="date" readonly required
                           style="width:100%; padding:5px 35px 5px 10px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em;">
                    <span class="date-icon" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:1.1em; color:#666;">&#128197;</span>
                </div>
            </div>

            <!-- Description -->
            <div class="form-group" style="display:flex; align-items:flex-start; margin-bottom:20px;">
                <label for="description" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Item Description :</label>
                <textarea id="description" name="description" rows="4" readonly
                          style="flex-grow:1; padding:5px 7px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em; resize:vertical;"></textarea>
            </div>

            <div class="form-group" style="display:flex; align-items:flex-end; margin-top:30px;">
                <label for="photo" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">Upload Photo :</label> 
                    <input type="text" id="photo" name="photo" readonly
                           style="flex-grow:1; padding:2px 7px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em;">
            </div>

            <div class="form-group" style="display:flex; align-items:center; margin-top:25px; margin-bottom:15px;">
                <label for="status" style="flex-basis:150px; font-weight:bold; color:#333; padding-right:15px; white-space:nowrap;">
                    Product Status :
                </label>
                <select id="status" name="status" required
                        style="flex-grow:1; padding:5px 7px; border:none; background:linear-gradient(to bottom,#f7f7f7 0%,#e8e8e8 100%); border-radius:4px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); font-size:1em;">
                    <option value="">-- Select Status --</option>
                    <option value="1">✅ Received</option>
                    <option value="0">❌ Not Yet</option>
                </select>
            </div>

            <div class="button-group" style="display:flex; justify-content:flex-start; gap:15px; margin-top:30px; margin-left:100px;">
                <button type="button" onclick="UpdateStatus()"
                        style="padding:3px 20px; background-color:#4a4a4a; color:white; border:none; border-radius:4px; font-size:0.9em; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                    Submit
                </button>
            </div>
        </div>
    </div>
</div>




<partial name="~/Views/Navbar/NavbarIndex.cshtml" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<div class="Lost" style="height:495px;">
    <h2 style="text-align:center;font-size:35px;margin-top:10px;margin-bottom: -23px;">ReportFound Items</h2>
    <div class="searchbar" id="searchbar">
        <span class="icon-left"><i class="fa-solid fa-bars"></i></span>
        <input type="text" placeholder="Item Name" name="search" id="search">
        <span class="icon-right"><i class="fa-solid fa-magnifying-glass" onclick="SearchItem()"></i></span>
    </div>
    <div class="container">
    </div>
</div>
<partial name="~/Views/Footer/FooterIndex.cshtml" />

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<script>

    $(document).ready(function()
    {
        GetLostDataAll();
    });

    function GetLostDataAll()
    {
        let userId = '@userId';

        if (!userId)
        {
            console.warn("User ID not found in session!");
            return;
        }

        $.ajax({
            url: '/ReportFound/FetchData',
            type: 'POST',
            data: { userId: userId },
            success: function(response)
            {
                console.log(response);

                let container = $('.container');
                container.empty();

                if (!response || response.length === 0)
                {
                    container.html('<p style="text-align:center;">No items found</p>');
                    return;
                }

                response.forEach(item => {
                    let cardHtml = `
                        <div class="student-card" data-userid="${item.userId}" data-id="${item.id}">
                            <div></div>
                            <div class="card-header">
                                <div class="avatar">${item.name ? item.name.charAt(0) : '?'}</div>
                                <div class="info">
                                    <h3>${item.name}</h3>
                                    <p>${new Date(item.dateLost).toLocaleDateString()}</p>
                                </div>
                            </div>

                            <div class="card-image">
                                <img src="${item.photoPath}" alt="${item.item}" />
                            </div>

                            <div class="card-content">
                                <h4>Item: ${item.item}</h4>
                                <p class="location">Location: ${item.location}</p>
                                <p class="description">Desc: ${item.description}</p>
                                <p class="phone">Phone: ${item.phone}</p>
                            </div>

                            <div class="card-footer">
                                <button class="contact-btn">Report</button>
                            </div>
                        </div>
                    `;
                    container.append(cardHtml);
                });
            },
            error: function(xhr, status, error)
            {
                console.error("AJAX Error:", error);
            }
        });
    }




    function SearchItem()
    {
        let item = document.getElementById("search").value;
        let userId = '@userId';

        if (!userId)
        {
            console.warn("User ID not found in session!");
            return;
        }

        $.ajax({
            url: '/ReportFound/Search',
            type: 'POST',
            data: { userId: userId , item : item},
            success: function(response)
            {
                console.log(response);

                let container = $('.container');
                container.empty();

                if (!response || response.length === 0)
                {
                    container.html('<p style="text-align:center;">No items found</p>');
                    return;
                }

                response.forEach(item => {
                    let cardHtml = `
                        <div class="student-card">
                            <div class="card-header">
                                <div class="avatar">${item.name ? item.name.charAt(0) : '?'}</div>
                                <div class="info">
                                    <h3>${item.name}</h3>
                                    <p>${new Date(item.dateLost).toLocaleDateString()}</p>
                                </div>
                            </div>

                            <div class="card-image">
                                <img src="${item.photoPath}" alt="${item.item}" />
                            </div>

                            <div class="card-content">
                                <h4>Item: ${item.item}</h4>
                                <p class="location">Location: ${item.location}</p>
                                <p class="description">Desc: ${item.description}</p>
                                <p class="phone">Phone: ${item.phone}</p>
                            </div>

                            <div class="card-footer">
                                <button class="contact-btn" disabled>Report</button>
                            </div>
                        </div>
                    `;
                    container.append(cardHtml);
                });
            },
            error: function(xhr, status, error)
            {
                console.error("AJAX Error:", error);
            }
        });
    }



    $(document).on('click', '.contact-btn', function () 
    {
        const card = $(this).closest('.student-card');

        const ownerUserId = card.data('userid');
        const lostItemId = card.data('id');
        const name = card.find('.info h3').text().trim();
        const dateText = card.find('.info p').text().trim();
        const itemName = card.find('h4').text().replace('Item:', '').trim();
        const location = card.find('.location').text().replace('Location:', '').trim();
        const description = card.find('.description').text().replace('Desc:', '').trim();
        const phone = card.find('.phone').text().replace('Phone:', '').trim();
        const imageSrc = card.find('.card-image img').attr('src');

        $('#OwnerUserId').val(ownerUserId);
        $('#LostItemId').val(lostItemId);
        $('#name').val(name);
        $('#item').val(itemName);
        $('#location').val(location);
        $('#description').val(description);

        const parsedDate = new Date(dateText);
        if (!isNaN(parsedDate)) 
        {
            $('#date').val(parsedDate.toISOString().split('T')[0]);
        }

        if ($('#phone').length) 
        {
            $('#phone').val(phone);
        }

        // document.getElementById('photo').value = imageSrc;
        $('#photo').val(imageSrc);

        console.log(imageSrc);


        $('#customModal').fadeIn(200);
        $('body').css('overflow', 'hidden'); 
    });

    $(document).on('click', '.close-btn', function () 
    {
        $('#customModal').fadeOut(200);
        $('body').css('overflow', 'auto');
    });


    $(document).on('click', '.close-btn', function ()
    {
        $('#customModal').fadeOut(200);
    });

    $(window).on('click', function (e)
    {
        if ($(e.target).is('#customModal'))
        {
            $('#customModal').fadeOut(200);
        }
    });


    function UpdateStatus()
    {
        const ownerUserId = document.getElementById("OwnerUserId").value;
        const lostItemId = document.getElementById("LostItemId").value;
        const status = document.getElementById("status").value;
        console.log(ownerUserId, lostItemId, status)


        $.ajax({
            url: '/ReportFound/UpdateStat',
            type: 'POST',
            data: { ownerUserId: ownerUserId , lostItemId : lostItemId, status : status},
            success: function (response) {
                $('#customModal').fadeOut(200);
                Swal.fire({
                    icon: 'success',
                    title: 'Updated!',
                    text: 'Product status updated successfully.',
                    showConfirmButton: false,
                    timer: 1800
                });

            },
            error: function (xhr, status, error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Something went wrong while updating status.',
                });
                console.error("AJAX Error:", error);
            }
      });
    }

</script>


