@page
@model Lost_and_Found.Views.Profile.ProfileIndexModel
@{
    Layout = null;
}


@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    var userId = HttpContextAccessor.HttpContext?.Session?.GetInt32("UserId");
    var username = HttpContextAccessor.HttpContext?.Session?.GetString("UserName");
    var useremail = HttpContextAccessor.HttpContext?.Session?.GetString("UserEmail");
}

@{
    var profile = ViewBag.Profile;
    bool hasProfile = ViewBag.HasProfile ?? false;
}


<link href="~/css/Profile.css" rel="stylesheet" />
<partial name="~/Views/Navbar/NavbarIndex.cshtml" />

<div class="profile-container" style="height:495px;">
    <h2 class="profile-title">Profile</h2>

    <div class="profile-box">
        <div class="profile-pic-container">
            <div class="profile-pic-frame">
                <img src="@(profile?.PhotoPath ?? "https://cdn-icons-png.flaticon.com/512/847/847969.png")"
                     alt="Profile Picture" id="preview">
            </div>
            <input type="file" id="profile-pic" accept="image/*" />
            <label for="profile-pic" class="upload-label">Choose Profile Picture</label>
        </div>

        <label for="name">Name</label>
        <input type="text" id="name" name="name" value="@profile?.name" placeholder="Name" @(!hasProfile ? "readonly" : "") />

        <label for="email">Email Id</label>
        <input type="email" id="email" name="email" value="@profile?.email" placeholder="Email" @(!hasProfile ? "readonly" : "") />

        <label for="phone">Phone</label>
        <input type="text" id="phone" name="phone" value="@profile?.phoneno" placeholder="+91 " />

        <label for="address">Address</label>
        <input type="text" id="address" name="address" value="@profile?.address" placeholder="village, district, state" />

        <div class="btn-group">
            @if (hasProfile)
            {
                <button type="button" onclick="UpdateProfile()"
                        style="margin:auto; padding:2px 32px; border-radius:4px; background-color:black; color:white;">
                    Update
                </button>
            }
            else
            {
                <button type="button" onclick="BtnClick()" class="save-btn"
                        style="margin:auto; padding:2px 32px; border-radius:4px; background-color:black; color:white;">
                    Save
                </button>
            }
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const input = document.getElementById("profile-pic");
    const preview = document.getElementById("preview");

    input.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
            preview.src = URL.createObjectURL(file);
        }
    });

    function BtnClick() 
    {
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const address = document.getElementById('address').value;
        const photoInput = document.getElementById('profile-pic');

        const userId = '@userId';

        const formData = new FormData();
        // formData.append("name", name);
        formData.append("email", email);
        formData.append("phone", phone);
        formData.append("address", address);
        formData.append("userId", userId);

        if (photoInput.files.length > 0) {
            formData.append("photo", photoInput.files[0]);
        }

        $.ajax({
            url: '/Profile/SaveData',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) 
            {
                Swal.fire({
                    title: "Success!",
                    text: response.message,
                    icon: "success",
                    confirmButtonColor: "#3085d6",
                    confirmButtonText: "OK"
                }).then(() => {
                        location.reload();
                    });
            },
            error: function (xhr, status, error) 
            {
                console.error("AJAX error:", error);
                Swal.fire({
                    title: "Error!",
                    text: "Something went wrong while uploading.",
                    icon: "error",
                    confirmButtonColor: "#d33",
                    confirmButtonText: "Try Again"
                });
            }
        });
    }



    function UpdateProfile()
    {
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const address = document.getElementById('address').value;
        const photoInput = document.getElementById('profile-pic');

        const userId = '@userId';

        const formData = new FormData();
        formData.append("name", name);
        formData.append("email", email);
        formData.append("phone", phone);
        formData.append("address", address);
        formData.append("userId", userId);

        if (photoInput.files.length > 0) {
            formData.append("photo", photoInput.files[0]);
        }

        $.ajax({
            url: '/Profile/UpdateData',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response)
            {
                Swal.fire({
                    title: "Success!",
                    text: response.message,
                    icon: "success",
                    confirmButtonColor: "#3085d6",
                    confirmButtonText: "OK"
                    }).then(() => {
                        location.reload(); 
                    });
            },
            error: function (xhr, status, error)
            {
                console.error("AJAX error:", error);
                Swal.fire({
                    title: "Error!",
                    text: "Something went wrong while uploading.",
                    icon: "error",
                    confirmButtonColor: "#d33",
                    confirmButtonText: "Try Again"
                });
            }
        });
    }

</script>

<partial name="~/Views/Footer/FooterIndex.cshtml" />